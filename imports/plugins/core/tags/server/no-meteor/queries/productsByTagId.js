import ReactionError from "@reactioncommerce/reaction-error";

/**
 * @name queries.productsByTagId
 * @method
 * @memberof Tags/GraphQL
 * @summary get a list of products by tag id
 * @param {Object} context - an object containing the per-request state
 * @param {Object} [params] - an object of all arguments that were sent by the client
 * @param {String} [params.shopId] - Shop ID
 * @param {String} [params.tagId] - Tag ID
 * @return {Promise<Array<Object>>} array of TagProducts
 */
export default async function productsByTagId(context, params) {
  const { shopId, tagId } = params;
  const { collections, userHasPermission } = context;
  const { Products, Tags } = collections;

  // Check for owner or admin permissions from the user before allowing the query
  if (!userHasPermission(["owner", "admin"], shopId)) {
    throw new ReactionError("access-denied", "User does not have permission");
  }

  const tag = await Tags.findOne({
    _id: tagId
  });

  if (!tag) {
    throw new ReactionError("not-found", "Tag not found");
  }

  // Aggregation Pipeline
  // Find the products in the "order" array
  const match = {
    $match: {
      shopId,
      hashtags: { $in: [tagId] }
    }
  };

  // If there are no featuredProductIds, return match without any sorting
  if (!tag.featuredProductIds) {
    return {
      collection: Products,
      pipeline: [match]
    };
  }

  // Products from catalog sample data
  const positions = tag.featuredProductIds;


  // Add a new field "positions" to each product with the order they are in the array
  const addFields = {
    $addFields: {
      position: {
        $indexOfArray: [positions, "$_id"]
      }
    }
  };

  // Projection: Add a featuredPosition by order
  const projection = {
    $project: {
      _id: 1,
      position: 1,
      title: 1,
      sortPosition: {
        $cond: {
          if: { $lt: ["$position", 0] },
          then: { $add: [{ $abs: "$position" }, positions.length] },
          else: "$position"
        }
      }
    }
  };

  // Sort the results by "positions"
  const sort = {
    $sort: {
      sortPosition: 1
    }
  };

  // Profit
  return {
    collection: Products,
    pipeline: [match, addFields, projection, sort]
  };
}
